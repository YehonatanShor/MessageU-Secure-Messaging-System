# Workflow to verify code integrity on every push and pull request
name: Code Compilation Check

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

jobs:
  # Verify C++ Client compilation on Windows environment
  check-client-compilation:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Build Tools and Libraries
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-crypto++

      - name: Compile Client Source
        run: |
          cd client/src
          g++ main.cpp MessageUClient.cpp RSAWrapper.cpp Base64Wrapper.cpp AESWrapper.cpp network/connection.cpp network/protocol_handler.cpp crypto/key_manager.cpp crypto/encryption.cpp storage/file_manager.cpp storage/client_storage.cpp ui/menu.cpp -o test.exe -std=c++17 -lWs2_32 -lpthread -lcryptopp -I../include

  # Verify Python Server syntax and style
  check-server-compilation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Dependencies and Linters
        run: |

          python -m pip install --upgrade pip
          pip install flake8
          if [ -f server/requirements.txt ]; then pip install -r server/requirements.txt; fi

      - name: Run Static Code Analysis (flake8)
        run: |

          # 1. Critical Syntax Check: Fails if the code cannot run at all
          flake8 server --count --select=E9,F63,F7,F82 --show-source --statistics

          # 2. Style Check: Display warnings but DO NOT fail the build (--exit-zero)
          # Increased max-complexity to 15 to accommodate the 'read' function
          flake8 server --count --max-complexity=15 --max-line-length=127 --statistics --exit-zero

      - name: Run Integration Test
        run: |

          # Change directory into 'server' so python can find 'myport.info'
          cd server
          python server.py &

          # Go back to root directory to run the test script correctly
          cd ..

          # Wait for server and DB to be ready
          sleep 5 

          # Execute the registration integration test
          python tests/integration_test.py

      - name: Build Docker Image
        run: |
          docker build -t messageu-server-test .

  # New Job: Push to Docker Hub only on Tag creation
  push-to-dockerhub:
    needs: [check-server-compilation] # Run only if tests pass
    if: startsWith(github.ref, 'refs/tags/') # Run only when creating a release tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # Replace 'yehonatanshor' with your actual Docker Hub username
          tags: |
            yehonatanshor/messageu-server:latest
            yehonatanshor/messageu-server:${{ github.ref_name }}
