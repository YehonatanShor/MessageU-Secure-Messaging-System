# Workflow to verify code integrity on every push and pull request
name: Code Compilation Check

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

jobs:
  # Verify C++ Client compilation on Windows environment
  check-client-compilation:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Build Tools and Libraries
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-crypto++

      - name: Compile Client Source
        run: |
          cd client/src
          g++ main.cpp MessageUClient.cpp RSAWrapper.cpp Base64Wrapper.cpp AESWrapper.cpp network/connection.cpp network/protocol_handler.cpp crypto/key_manager.cpp crypto/encryption.cpp storage/file_manager.cpp storage/client_storage.cpp ui/menu.cpp handlers/base_handler.cpp handlers/registration_handler.cpp handlers/client_list_handler.cpp handlers/public_key_handler.cpp handlers/messaging_handler.cpp handlers/deletion_handler.cpp -o test.exe -std=c++17 -lWs2_32 -lpthread -lcryptopp -I../include

  # Verify Python Server syntax and style
  check-server-compilation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Dependencies and Linters
        run: |

          python -m pip install --upgrade pip
          pip install flake8
          if [ -f server/requirements.txt ]; then pip install -r server/requirements.txt; fi

      - name: Run Static Code Analysis (flake8)
        run: |

          # 1. Critical Syntax Check: Fails if the code cannot run at all
          flake8 server --count --select=E9,F63,F7,F82 --show-source --statistics

          # 2. Style Check: Display warnings but DO NOT fail the build (--exit-zero)
          # Increased max-complexity to 15 to accommodate the 'read' function
          flake8 server --count --max-complexity=15 --max-line-length=127 --statistics --exit-zero

      - name: Run Integration Test
        run: |

          # Change directory into 'server' so python can find 'myport.info'
          cd server
          python server.py &

          # Go back to root directory to run the test script correctly
          cd ..

          # Wait for server and DB to be ready
          sleep 5 

          # Execute the registration integration test
          python tests/integration_test.py

      - name: Build Docker Image
        run: |
          docker build -t messageu-server-test .

  # New Job: Build and Push to Docker Hub
  push-to-dockerhub:
    needs: [check-server-compilation] # Run only if tests pass
    # Run on tags OR on main branch pushes (to keep latest updated)
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history to ensure we have the full code

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify Git state
        run: |
          echo "Git commit SHA: ${{ github.sha }}"
          echo "Git ref: ${{ github.ref }}"
          echo "Git tag: ${{ github.ref_name }}"
          git log --oneline -5
          echo "Current directory structure:"
          ls -la

      - name: Verify server structure before build
        run: |
          echo "=== Checking server structure ==="
          echo "Server directory contents:"
          ls -la server/ || exit 1
          echo ""
          echo "=== Checking for modular structure ==="
          MISSING=0
          test -d server/config && echo "✓ config/ exists" || { echo "✗ config/ missing"; MISSING=1; }
          test -d server/database && echo "✓ database/ exists" || { echo "✗ database/ missing"; MISSING=1; }
          test -d server/network && echo "✓ network/ exists" || { echo "✗ network/ missing"; MISSING=1; }
          test -d server/handlers && echo "✓ handlers/ exists" || { echo "✗ handlers/ missing"; MISSING=1; }
          test -d server/utils && echo "✓ utils/ exists" || { echo "✗ utils/ missing"; MISSING=1; }
          echo ""
          echo "=== Checking server.py ==="
          if [ ! -f server/server.py ]; then
            echo "✗ server.py file missing!"
            exit 1
          fi
          LINES=$(wc -l < server/server.py)
          echo "server.py has $LINES lines (should be ~70, not 600+)"
          if [ "$LINES" -gt 200 ]; then
            echo "✗ ERROR: server.py is too large ($LINES lines) - appears to be monolithic version!"
            echo "First 20 lines of server.py:"
            head -20 server/server.py
            exit 1
          fi
          echo "✓ server.py size is correct"
          echo ""
          echo "=== Checking for imports ==="
          if grep -q "from config import constants" server/server.py; then
            echo "✓ Uses modular imports (config)"
          else
            echo "✗ Missing modular import - appears to be old code"
            exit 1
          fi
          echo ""
          if [ "$MISSING" -eq 1 ]; then
            echo "✗ BUILD FAILED: Modular structure is incomplete!"
            exit 1
          fi
          echo "✓ All checks passed - ready to build Docker image"

      - name: Determine Docker tags
        id: docker_tags
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tags=yehonatanshor/messageu-server:${{ github.ref_name }},yehonatanshor/messageu-server:latest" >> $GITHUB_OUTPUT
            echo "no_cache=true" >> $GITHUB_OUTPUT
          else
            echo "tags=yehonatanshor/messageu-server:latest" >> $GITHUB_OUTPUT
            echo "no_cache=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          pull: true # Always pull base image to ensure freshness
          tags: ${{ steps.docker_tags.outputs.tags }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.run_started_at }}
            GIT_SHA=${{ github.sha }}
          # Build without cache for tags to ensure fresh build with latest code
          # Use cache for main branch pushes (faster, but still fresh code)
          no-cache: ${{ steps.docker_tags.outputs.no_cache == 'true' }}
