# Workflow to verify code integrity on every push and pull request
name: Code Compilation Check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # Verify C++ Client compilation on Windows environment
  check-client-compilation:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0} # Use MSYS2 for access to G++ and MINGW64 libraries

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Build Tools and Libraries
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-crypto++

      - name: Compile Client Source
        run: |
          cd client/src
          # Verification build. Using test.exe to avoid Windows-specific /dev/null issues.
          # -I../include ensures the compiler finds separated header files.
          g++ main.cpp MessageUClient.cpp RSAWrapper.cpp Base64Wrapper.cpp AESWrapper.cpp -o test.exe -std=c++17 -lWs2_32 -lpthread -lcryptopp -I../include

  # Verify Python Server syntax and style (Linting)
  check-server-compilation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies and Linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          if [ -f server/requirements.txt ]; then pip install -r Server/requirements.txt; fi

      - name: Run Static Code Analysis (flake8)
        run: |
          # Fails the build if there are syntax errors or undefined names
          flake8 server --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings and complexity check (Optional: exit-zero to not fail build on style)
          flake8 server --count --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Integration Test
        run: |
          # 1. Start the server in the background
          python server/server.py & 
          # 2. Wait a few seconds for server to initialize
          sleep 5 
          # 3. Run the integration script
          python tests/integration_test.py
