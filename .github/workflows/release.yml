# Workflow for automated building and distributing official client releases
name: Build and Release Windows Client

on:
  push:
    tags:
      - "v*" # Trigger only on version tags (e.g., v1.3)

jobs:
  build-and-deploy:
    runs-on: windows-latest

    permissions:
      contents: write # Required permission to upload assets to GitHub Releases

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Compilation Environment
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-crypto++

      - name: Build Production Executable
        run: |
          cd client/src
          # -static links libraries into the .exe for standalone execution on any Windows machine
          g++ main.cpp MessageUClient.cpp RSAWrapper.cpp Base64Wrapper.cpp AESWrapper.cpp network/connection.cpp network/protocol_handler.cpp crypto/key_manager.cpp crypto/encryption.cpp storage/file_manager.cpp storage/client_storage.cpp ui/menu.cpp handlers/base_handler.cpp handlers/registration_handler.cpp handlers/client_list_handler.cpp handlers/public_key_handler.cpp handlers/messaging_handler.cpp handlers/deletion_handler.cpp -o MessageUClient.exe -std=c++17 -lWs2_32 -lpthread -lcryptopp -static -I../include

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: client/src/MessageUClient.exe
